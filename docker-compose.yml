version: "3.9"

# Each service gets its own PostgreSQL container matching the port in its
# application.yml. No app config changes required.
#
# Start everything:   docker-compose up -d
# Stop everything:    docker-compose down
# Wipe data:          docker-compose down -v
#
# Individual DB only: docker-compose up -d customerdb accountdb paymentdb


services:

  customerdb:
    image: postgres:16-alpine
    container_name: customerdb
    environment:
      POSTGRES_DB: customerdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: root
    ports:
      - "5000:5432"
    volumes:
      - customerdb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d customerdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  accountdb:
    image: postgres:16-alpine
    container_name: accountdb
    environment:
      POSTGRES_DB: accountdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: root
    ports:
      - "5001:5432"
    volumes:
      - accountdb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d accountdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  paymentdb:
    image: postgres:16-alpine
    container_name: paymentdb
    environment:
      POSTGRES_DB: paymentdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: root
    ports:
      - "5002:5432"
    volumes:
      - paymentdb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d paymentdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  notificationdb:
    image: postgres:16-alpine
    container_name: notificationdb
    environment:
      POSTGRES_DB: notificationdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: root
    ports:
      - "5003:5432"
    volumes:
      - notificationdb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d notificationdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  analyticsdb:
    image: mongo:7
    container_name: analyticsdb
    ports:
      - "27017:27017"
    volumes:
      - analyticsdb_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet"]
      interval: 10s
      timeout: 5s
      retries: 5

  authdb:
    image: postgres:16-alpine
    container_name: authdb
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: root
    ports:
      - "5005:5432"
    volumes:
      - authdb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d authdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  #Kafka (KRaft mode — no Zookeeper)
  # KRaft is Kafka's built-in consensus protocol (Kafka 3.3+).
  # Removes the Zookeeper dependency, simpler to run locally.

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: kafka
    ports:
      - "9094:9094"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      # INTERNAL: container-to-container traffic on port 9092
      # EXTERNAL: host machine access on port 9094
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,EXTERNAL://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qg"
    volumes:
      - kafka_data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ── Zipkin (Distributed Tracing UI) ────────────────────────────────────────
  zipkin:
    image: openzipkin/zipkin:3
    container_name: zipkin
    ports:
      - "9411:9411"

  # ── App Services ────────────────────────────────────────────────────────────

  customer-service:
    build:
      context: .
      dockerfile: customer.Dockerfile
    container_name: customer-service
    ports:
      - "3001:3001"
      - "9090:9090"
    environment:
      - DB_HOST=customerdb
      - DB_PORT=5432
      - DB_USER=admin
      - DB_PASSWORD=root
      - ACCOUNT_SERVICE_HOST=account-service
    depends_on:
      customerdb:
        condition: service_healthy
      account-service:
        condition: service_started

  account-service:
    build:
      context: .
      dockerfile: account.Dockerfile
    container_name: account-service
    ports:
      - "3002:3002"
      - "9091:9091"
    environment:
      - DB_HOST=accountdb
      - DB_PORT=5432
      - DB_USER=admin
      - DB_PASSWORD=root
      - CUSTOMER_SERVICE_HOST=customer-service
    depends_on:
      accountdb:
        condition: service_healthy

  payment-service:
    build:
      context: .
      dockerfile: payment.Dockerfile
    container_name: payment-service
    ports:
      - "3003:3003"
      - "9092:9092"
    environment:
      - DB_HOST=paymentdb
      - DB_PORT=5432
      - DB_USER=admin
      - DB_PASSWORD=root
      - ACCOUNT_SERVICE_HOST=account-service
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      paymentdb:
        condition: service_healthy
      kafka:
        condition: service_healthy

  notification-service:
    build:
      context: .
      dockerfile: notification.Dockerfile
    container_name: notification-service
    ports:
      - "3004:3004"
    environment:
      - DB_HOST=notificationdb
      - DB_PORT=5432
      - DB_USER=admin
      - DB_PASSWORD=root
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      notificationdb:
        condition: service_healthy
      kafka:
        condition: service_healthy

  analytics-service:
    build:
      context: .
      dockerfile: analytics.Dockerfile
    container_name: analytics-service
    ports:
      - "3005:3005"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - MONGODB_URI=mongodb://analyticsdb:27017/analyticsdb
    depends_on:
      analyticsdb:
        condition: service_healthy
      kafka:
        condition: service_healthy

  auth-service:
    build:
      context: .
      dockerfile: auth.Dockerfile
    container_name: auth-service
    ports:
      - "3006:3006"
    environment:
      - DB_HOST=authdb
      - DB_PORT=5432
      - DB_USER=admin
      - DB_PASSWORD=root
    depends_on:
      authdb:
        condition: service_healthy

  api-gateway:
    build:
      context: .
      dockerfile: gateway.Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - AUTH_SERVICE_HOST=auth-service
      - CUSTOMER_SERVICE_HOST=customer-service
      - ACCOUNT_SERVICE_HOST=account-service
      - PAYMENT_SERVICE_HOST=payment-service
      - ANALYTICS_SERVICE_HOST=analytics-service
    depends_on:
      - auth-service
      - customer-service
      - account-service
      - payment-service
      - analytics-service

#
volumes:
  customerdb_data:
  accountdb_data:
  paymentdb_data:
  notificationdb_data:
  analyticsdb_data:
  authdb_data:
  kafka_data:
